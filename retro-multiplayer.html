<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïπÔ∏è MULTIPLAYER RETRO RETROSPECTIVE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1000;
        }

        .arcade-cabinet {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1e 100%);
            border: 8px solid #ff006e;
            border-radius: 20px;
            box-shadow: 
                0 0 20px #ff006e,
                0 0 40px #ff006e;
            max-width: 1200px;
            width: 100%;
        }

        .screen-bezel {
            background: #000;
            border: 6px solid #333;
            margin: 20px;
            border-radius: 10px;
        }

        .header {
            background: linear-gradient(180deg, #ff006e 0%, #8b0042 100%);
            padding: 30px;
            text-align: center;
            border-bottom: 4px solid #00ffff;
        }

        .title {
            font-size: 1.5em;
            color: #ffff00;
            text-shadow: 
                3px 3px 0 #ff006e,
                6px 6px 0 #00ffff;
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 0.6em;
            color: #00ffff;
        }

        .content {
            padding: 40px;
            min-height: 500px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .info-box {
            background: #1a1a2e;
            border: 3px solid #00ffff;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            text-align: center;
        }

        .info-box h2 {
            color: #ffff00;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #00ffff;
            font-size: 0.7em;
            line-height: 1.8;
            margin: 15px 0;
        }

        .pixel-button {
            background: #ff006e;
            color: #ffff00;
            border: 4px solid #ffff00;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 4px 4px 0 #000;
            margin: 10px;
        }

        .pixel-button:hover {
            background: #ffff00;
            color: #ff006e;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }

        .retro-input {
            background: #000;
            color: #00ff00;
            border: 3px solid #00ff00;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            display: block;
        }

        .retro-input:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .instructions {
            background: #2d2d44;
            border-left: 5px solid #ffff00;
            padding: 20px;
            margin: 20px 0;
            font-size: 0.6em;
            line-height: 1.8;
            color: #00ffff;
        }

        .instructions h3 {
            color: #ffff00;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin: 10px 0;
        }

        .warning {
            background: #ff006e;
            color: #ffff00;
            padding: 15px;
            margin: 20px 0;
            border: 3px solid #ffff00;
            font-size: 0.6em;
            text-align: center;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 1em;
            }
            
            .pixel-button {
                font-size: 0.6em;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>

    <div class="arcade-cabinet">
        <div class="screen-bezel">
            <div class="header">
                <div class="title">MULTIPLAYER RETRO RETROSPECTIVE</div>
                <div class="subtitle">COLLABORATIVE TEAM FEEDBACK</div>
            </div>

            <div class="content">
                <div id="setupScreen" class="screen active">
                    <div class="info-box">
                        <h2>üéÆ SETUP MULTIPLAYER SESSION</h2>
                        <p>Choose how you want to collaborate with your team</p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;">
                        <div id="hostOption" class="info-box" style="cursor: pointer;" onclick="showHostSetup()">
                            <h2>üè† HOST SESSION</h2>
                            <p>Start a new retrospective and invite your team</p>
                            <button class="pixel-button">HOST</button>
                        </div>

                        <div class="info-box" style="cursor: pointer;" onclick="showJoinSetup()">
                            <h2>üîó JOIN SESSION</h2>
                            <p>Join an existing retrospective with a session code</p>
                            <button class="pixel-button">JOIN</button>
                        </div>
                    </div>

                    <div class="instructions">
                        <h3>HOW IT WORKS</h3>
                        <ol>
                            <li><strong>HOST</strong> creates a session and shares the session code</li>
                            <li><strong>TEAM MEMBERS</strong> join using the code</li>
                            <li><strong>EVERYONE</strong> submits their responses independently</li>
                            <li><strong>HOST</strong> can view all responses and export summary</li>
                        </ol>
                    </div>

                    <div class="warning">
                        ‚ö†Ô∏è REAL-TIME SYNC: This version uses Firebase for instant synchronization across all devices. Everyone sees updates in real-time!
                    </div>
                </div>

                <div id="hostScreen" class="screen">
                    <div class="info-box">
                        <h2>üè† HOST A SESSION</h2>
                        <p>Enter your name and create a session code</p>
                        
                        <input type="text" id="hostName" class="retro-input" placeholder="YOUR NAME" maxlength="20">
                        <input type="text" id="sessionCode" class="retro-input" placeholder="SESSION CODE (e.g., RETRO2024)" maxlength="15">
                        
                        <div style="margin-top: 30px;">
                            <button class="pixel-button" onclick="createSession()">CREATE SESSION</button>
                            <button class="pixel-button" style="background: #666;" onclick="backToSetup()">BACK</button>
                        </div>
                    </div>
                </div>

                <div id="joinScreen" class="screen">
                    <div class="info-box">
                        <h2>üîó JOIN A SESSION</h2>
                        <p>Enter your name and the session code from your host</p>
                        
                        <input type="text" id="joinName" class="retro-input" placeholder="YOUR NAME" maxlength="20">
                        <input type="text" id="joinCode" class="retro-input" placeholder="SESSION CODE" maxlength="15">
                        
                        <div style="margin-top: 30px;">
                            <button class="pixel-button" onclick="joinSession()">JOIN SESSION</button>
                            <button class="pixel-button" style="background: #666;" onclick="backToSetup()">BACK</button>
                        </div>
                    </div>
                </div>

                <div id="lobbyScreen" class="screen">
                    <div class="info-box">
                        <h2 id="lobbyTitle">üéÆ SESSION LOBBY</h2>
                        <p id="sessionInfo"></p>
                        
                        <div id="playersList" style="margin: 30px 0;"></div>
                        
                        <div id="gameSelection" style="display: none; margin: 30px 0;">
                            <div style="color: #ffff00; font-size: 0.9em; margin-bottom: 20px;">
                                SELECT GAME MODE
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <button class="pixel-button" onclick="selectGame('pacman')" style="font-size: 0.6em;">
                                    üü° PAC-RETRO
                                </button>
                                <button class="pixel-button" onclick="selectGame('mario')" style="font-size: 0.6em;">
                                    üçÑ SUPER SPRINT
                                </button>
                                <button class="pixel-button" onclick="selectGame('spaceinvaders')" style="font-size: 0.6em;">
                                    üëæ SPACE RETRO
                                </button>
                                <button class="pixel-button" onclick="selectGame('tetris')" style="font-size: 0.6em;">
                                    üü¶ TETRO-SPECT
                                </button>
                            </div>
                        </div>
                        
                        <div id="selectedGameDisplay" style="display: none; margin: 30px 0;">
                            <div style="background: #000; border: 3px solid #ffff00; padding: 20px; border-radius: 10px;">
                                <div style="color: #ffff00; font-size: 0.8em; margin-bottom: 10px;">SELECTED GAME</div>
                                <div id="selectedGameName" style="color: #00ffff; font-size: 1em;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button class="pixel-button" id="startGameBtn" onclick="startMultiplayerGame()" style="display: none;">START GAME</button>
                            <button class="pixel-button" id="downloadResponsesBtn" onclick="downloadCombinedResponses()" style="display: none; background: #00ff00; color: #000;">üì• DOWNLOAD ALL RESPONSES</button>
                            <button class="pixel-button" onclick="exportSession()">üì§ EXPORT</button>
                            <button class="pixel-button" onclick="importSession()">üì• IMPORT</button>
                            <button class="pixel-button" style="background: #666;" onclick="leaveSession()">LEAVE</button>
                        </div>
                    </div>
                </div>

                <div id="gameScreen" class="screen">
                    <iframe id="gameFrame" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ‚ö†Ô∏è FIREBASE CONFIGURATION - REPLACE WITH YOUR OWN
        // Get your config from: https://console.firebase.google.com/
        const firebaseConfig = {
        apiKey: "AIzaSyBoST2tp0rM5hyb16iGDtC-4c9IpHnTajA",
        authDomain: "alpha-retro.firebaseapp.com",
        databaseURL: "https://alpha-retro-default-rtdb.firebaseio.com",
        projectId: "alpha-retro",
        storageBucket: "alpha-retro.firebasestorage.app",
        messagingSenderId: "54510928928",
        appId: "1:54510928928:web:8d5546e7734c469ae6e845"
        };

        // Initialize Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            alert('Firebase not configured! Please add your Firebase config. See console for details.');
        }

        let currentSession = null;
        let currentPlayer = null;
        let sessionListener = null;
        let responsesDownloaded = false;

        function showHostSetup() {
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('hostScreen').classList.add('active');
        }

        function showJoinSetup() {
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('joinScreen').classList.add('active');
        }

        function backToSetup() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('setupScreen').classList.add('active');
        }

        function createSession() {
            const name = document.getElementById('hostName').value.trim();
            const code = document.getElementById('sessionCode').value.trim().toUpperCase();
            
            if (!name || !code) {
                alert('Please enter both name and session code!');
                return;
            }
            
            if (!database) {
                alert('Firebase not initialized! Please configure Firebase first.');
                return;
            }
            
            currentSession = {
                code: code,
                host: name,
                players: [{ name: name, isHost: true, responses: {} }],
                gameType: null,
                selectedGame: null,
                responses: {},
                createdAt: new Date().toISOString()
            };
            
            currentPlayer = { name: name, isHost: true };
            
            // Save to Firebase
            database.ref('sessions/' + code).set(currentSession)
                .then(() => {
                    console.log('‚úÖ Session created in Firebase');
                    localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
                    localStorage.setItem('currentSessionCode', code);
                    showLobby();
                    listenToSession(code);
                })
                .catch((error) => {
                    console.error('‚ùå Error creating session:', error);
                    alert('Error creating session: ' + error.message);
                });
        }

        function joinSession() {
            const name = document.getElementById('joinName').value.trim();
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            if (!name || !code) {
                alert('Please enter both name and session code!');
                return;
            }
            
            if (!database) {
                alert('Firebase not initialized! Please configure Firebase first.');
                return;
            }
            
            // Check if session exists in Firebase
            database.ref('sessions/' + code).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('Session not found! Check the code with your host.');
                        return;
                    }
                    
                    currentSession = snapshot.val();
                    
                    // Check if player already exists
                    const existingPlayer = currentSession.players.find(p => p.name === name);
                    if (existingPlayer) {
                        currentPlayer = existingPlayer;
                    } else {
                        currentPlayer = { name: name, isHost: false, responses: {} };
                        currentSession.players.push(currentPlayer);
                        
                        // Update Firebase with new player
                        database.ref('sessions/' + code + '/players').set(currentSession.players);
                    }
                    
                    localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
                    localStorage.setItem('currentSessionCode', code);
                    
                    showLobby();
                    listenToSession(code);
                })
                .catch((error) => {
                    console.error('‚ùå Error joining session:', error);
                    alert('Error joining session: ' + error.message);
                });
        }

        function showLobby() {
            // Check if game has started - auto-load for all players
            if (currentSession.gameStarted && currentSession.selectedGame) {
                loadGame();
                return;
            }
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('lobbyScreen').classList.add('active');
            
            document.getElementById('sessionInfo').textContent = 
                `SESSION CODE: ${currentSession.code} | HOST: ${currentSession.host}`;
            
            let playersHTML = '<div style="background: #000; border: 3px solid #00ffff; padding: 20px; border-radius: 10px;">';
            playersHTML += '<div style="color: #ffff00; font-size: 0.8em; margin-bottom: 15px;">PLAYERS IN LOBBY</div>';
            
            currentSession.players.forEach(player => {
                const icon = player.isHost ? 'üëë' : 'üéÆ';
                playersHTML += `<div style="color: #00ffff; font-size: 0.7em; margin: 10px 0;">${icon} ${player.name}</div>`;
            });
            
            playersHTML += '</div>';
            document.getElementById('playersList').innerHTML = playersHTML;
            
            // Show game selection only for host
            if (currentPlayer.isHost) {
                document.getElementById('gameSelection').style.display = 'block';
                document.getElementById('selectedGameDisplay').style.display = 'none';
                document.getElementById('downloadResponsesBtn').style.display = 'inline-block';
                
                // Show start button only if game is selected
                if (currentSession.selectedGame) {
                    document.getElementById('startGameBtn').style.display = 'inline-block';
                    document.getElementById('gameSelection').style.display = 'none';
                    document.getElementById('selectedGameDisplay').style.display = 'block';
                    document.getElementById('selectedGameName').textContent = getGameName(currentSession.selectedGame);
                } else {
                    document.getElementById('startGameBtn').style.display = 'none';
                }
            } else {
                // Non-host players see selected game or waiting message
                document.getElementById('gameSelection').style.display = 'none';
                document.getElementById('startGameBtn').style.display = 'none';
                document.getElementById('downloadResponsesBtn').style.display = 'none';
                
                if (currentSession.selectedGame) {
                    document.getElementById('selectedGameDisplay').style.display = 'block';
                    document.getElementById('selectedGameName').textContent = getGameName(currentSession.selectedGame);
                } else {
                    document.getElementById('selectedGameDisplay').style.display = 'block';
                    document.getElementById('selectedGameName').textContent = 'Waiting for host to select game...';
                }
            }
        }

        function getGameName(gameType) {
            const names = {
                'pacman': 'üü° PAC-RETRO',
                'mario': 'üçÑ SUPER SPRINT',
                'spaceinvaders': 'üëæ SPACE RETRO',
                'tetris': 'üü¶ TETRO-SPECT'
            };
            return names[gameType] || 'Unknown Game';
        }

        function selectGame(gameType) {
            if (!currentPlayer.isHost) {
                alert('Only the host can select the game!');
                return;
            }
            
            currentSession.selectedGame = gameType;
            
            // Update Firebase
            database.ref('sessions/' + currentSession.code + '/selectedGame').set(gameType)
                .then(() => {
                    playSound('coin');
                })
                .catch((error) => {
                    console.error('‚ùå Error updating game selection:', error);
                });
        }

        function startMultiplayerGame() {
            if (!currentPlayer.isHost) {
                alert('Only the host can start the game!');
                return;
            }
            
            if (!currentSession.selectedGame) {
                alert('Please select a game first!');
                return;
            }
            
            // Update Firebase to signal game has started
            database.ref('sessions/' + currentSession.code + '/gameStarted').set(true)
                .then(() => {
                    // Load the game for host
                    loadGame();
                })
                .catch((error) => {
                    console.error('‚ùå Error starting game:', error);
                    alert('Error starting game: ' + error.message);
                });
        }

        function loadGame() {
            // Load the original game in iframe with selected game
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('gameScreen').classList.add('active');
            
            // Load the retro game with game type parameter
            document.getElementById('gameFrame').src = `retro-retrospective-game.html?game=${currentSession.selectedGame}&autostart=true`;
            
            // Start listening for completion status changes
            listenToCompletionStatus();
        }

        // Listen for real-time completion status updates
        function listenToCompletionStatus() {
            if (!currentSession || !database) return;
            
            const responsesRef = database.ref('sessions/' + currentSession.code + '/playerResponses');
            responsesRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    // Send updated status to game iframe
                    sendCompletionStatusToGame();
                    
                    // Check if all players are complete
                    const allResponses = snapshot.val();
                    const totalPlayers = currentSession.players.length;
                    const completedPlayers = Object.values(allResponses).filter(r => r.completed).length;
                    
                    if (completedPlayers === totalPlayers) {
                        notifyAllPlayersComplete();
                    }
                }
            });
        }

        function playSound(type) {
            // Simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'coin') {
                oscillator.frequency.value = 1046.50;
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }

        function exportSession() {
            const dataStr = JSON.stringify(currentSession, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `retro-session-${currentSession.code}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('Session exported! This is a backup copy. All data is already synced in real-time via Firebase.');
        }

        function importSession() {
            alert('Import is for backup restoration only. With Firebase, sessions sync automatically across all devices!');
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (!database) {
                        alert('Firebase not initialized! Cannot import session.');
                        return;
                    }
                    
                    // Import to Firebase
                    database.ref('sessions/' + imported.code).set(imported)
                        .then(() => {
                            alert(`Session ${imported.code} imported to Firebase successfully! You can now join it.`);
                            backToSetup();
                        })
                        .catch((error) => {
                            console.error('‚ùå Error importing session:', error);
                            alert('Error importing session: ' + error.message);
                        });
                } catch (error) {
                    alert('Invalid session file!');
                }
            };
            reader.readAsText(file);
        }

        function leaveSession() {
            const isHost = currentPlayer && currentPlayer.isHost;
            
            // Check if host has downloaded responses
            if (isHost && !responsesDownloaded) {
                const forceLeave = confirm('‚ö†Ô∏è WARNING: You have not downloaded the team responses yet!\n\nIf you end the session now, all responses will be lost.\n\nClick OK to end session anyway, or Cancel to go back and download responses first.');
                
                if (!forceLeave) {
                    return; // Don't leave, let them download first
                }
            }
            
            const confirmMessage = isHost 
                ? 'Are you sure you want to end this session? This will disconnect all players and delete the session.'
                : 'Are you sure you want to leave this session?';
            
            if (confirm(confirmMessage)) {
                // If host is leaving, delete the entire session from Firebase
                if (isHost && currentSession && database) {
                    database.ref('sessions/' + currentSession.code).remove()
                        .then(() => {
                            console.log('‚úÖ Session deleted by host');
                        })
                        .catch((error) => {
                            console.error('‚ùå Error deleting session:', error);
                        });
                }
                
                // Stop listening to Firebase updates
                if (sessionListener) {
                    sessionListener.off();
                    sessionListener = null;
                }
                
                currentSession = null;
                currentPlayer = null;
                responsesDownloaded = false;
                localStorage.removeItem('currentPlayer');
                localStorage.removeItem('currentSessionCode');
                backToSetup();
            }
        }

        // Real-time listener for session updates
        function listenToSession(code) {
            if (sessionListener) {
                sessionListener.off();
            }
            
            sessionListener = database.ref('sessions/' + code);
            sessionListener.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    currentSession = snapshot.val();
                    showLobby();
                } else {
                    alert('Session has been deleted by the host.');
                    leaveSession();
                }
            });
        }

        // Check if returning player
        window.onload = function() {
            // Check for active sessions and hide host option if any exist
            checkForActiveSessions();
            
            const savedPlayer = localStorage.getItem('currentPlayer');
            const savedCode = localStorage.getItem('currentSessionCode');
            
            if (savedPlayer && savedCode && database) {
                currentPlayer = JSON.parse(savedPlayer);
                
                // Try to rejoin the session from Firebase
                database.ref('sessions/' + savedCode).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            currentSession = snapshot.val();
                            showLobby();
                            listenToSession(savedCode);
                        } else {
                            // Session no longer exists
                            localStorage.removeItem('currentPlayer');
                            localStorage.removeItem('currentSessionCode');
                        }
                    })
                    .catch((error) => {
                        console.error('‚ùå Error checking session:', error);
                    });
            }
        };

        // Check for active sessions in Firebase
        function checkForActiveSessions() {
            if (!database) return;
            
            // Try to check for sessions, but don't fail if permission denied
            database.ref('sessions').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // There are active sessions - hide host option
                        const hostOption = document.getElementById('hostOption');
                        if (hostOption) {
                            hostOption.style.display = 'none';
                        }
                        console.log('‚ÑπÔ∏è Active sessions found - host option hidden');
                    } else {
                        // No active sessions - show host option
                        const hostOption = document.getElementById('hostOption');
                        if (hostOption) {
                            hostOption.style.display = 'block';
                        }
                    }
                })
                .catch((error) => {
                    // Permission denied or other error - just show both options
                    console.log('‚ÑπÔ∏è Cannot check for active sessions (permission denied) - showing all options');
                    const hostOption = document.getElementById('hostOption');
                    if (hostOption) {
                        hostOption.style.display = 'block';
                    }
                });
        }

        // Listen for messages from game iframe (for reset/restart)
        window.addEventListener('message', function(event) {
            if (event.data && event.data.action === 'resetSession') {
                resetSessionForNewGame();
            } else if (event.data && event.data.action === 'downloadCombinedResponses') {
                savePlayerResponses(event.data.playerResponses);
            } else if (event.data && event.data.action === 'autoSaveResponses') {
                autoSavePlayerResponses(event.data.playerResponses);
            } else if (event.data && event.data.action === 'savePlayerResponses') {
                savePlayerResponsesOnly(event.data.playerResponses);
            } else if (event.data && event.data.action === 'requestCompletionStatus') {
                sendCompletionStatusToGame();
            }
        });

        // Reset session for a new game
        function resetSessionForNewGame() {
            if (!currentSession || !database) return;
            
            // Only host can reset
            if (!currentPlayer.isHost) {
                alert('Only the host can start a new game!');
                return;
            }
            
            if (confirm('Start a new retrospective? This will bring everyone back to the lobby.')) {
                // Reset session in Firebase
                database.ref('sessions/' + currentSession.code).update({
                    selectedGame: null,
                    gameStarted: false
                })
                .then(() => {
                    console.log('‚úÖ Session reset for new game');
                    // The real-time listener will automatically update all players
                })
                .catch((error) => {
                    console.error('‚ùå Error resetting session:', error);
                    alert('Error resetting session: ' + error.message);
                });
            }
        }

        // Save player responses to Firebase
        function savePlayerResponses(playerData) {
            if (!currentSession || !database || !currentPlayer) return;
            
            // Save this player's responses to Firebase
            const playerResponsesRef = database.ref('sessions/' + currentSession.code + '/playerResponses/' + currentPlayer.name);
            
            playerResponsesRef.set({
                game: playerData.game,
                responses: playerData.responses,
                score: playerData.score,
                completedAt: new Date().toISOString()
            })
            .then(() => {
                console.log('‚úÖ Responses saved to Firebase');
                
                // If host, download combined responses
                if (currentPlayer.isHost) {
                    downloadCombinedResponses();
                } else {
                    alert('Your responses have been saved! The host will download the combined summary.');
                }
            })
            .catch((error) => {
                console.error('‚ùå Error saving responses:', error);
                alert('Error saving responses: ' + error.message);
            });
        }

        // Auto-save player responses (called automatically when game ends)
        function autoSavePlayerResponses(playerData) {
            if (!currentSession || !database || !currentPlayer) return;
            
            // Save this player's responses to Firebase
            const playerResponsesRef = database.ref('sessions/' + currentSession.code + '/playerResponses/' + currentPlayer.name);
            
            playerResponsesRef.set({
                game: playerData.game,
                responses: playerData.responses,
                score: playerData.score,
                completedAt: new Date().toISOString()
            })
            .then(() => {
                console.log('‚úÖ Responses auto-saved to Firebase for ' + currentPlayer.name);
                
                // Hide save button for non-hosts, show message
                hideSaveButtonForNonHost();
            })
            .catch((error) => {
                console.error('‚ùå Error auto-saving responses:', error);
            });
        }

        // Save player responses only (no download)
        function savePlayerResponsesOnly(playerData) {
            if (!currentSession || !database || !currentPlayer) return;
            
            // Save this player's responses to Firebase with completion status
            const playerResponsesRef = database.ref('sessions/' + currentSession.code + '/playerResponses/' + currentPlayer.name);
            
            playerResponsesRef.set({
                game: playerData.game,
                responses: playerData.responses,
                score: playerData.score,
                completed: playerData.completed || false,
                completedAt: new Date().toISOString()
            })
            .then(() => {
                console.log('‚úÖ Responses saved to Firebase for ' + currentPlayer.name);
                
                // Check if all players have completed
                checkAllPlayersComplete();
            })
            .catch((error) => {
                console.error('‚ùå Error saving responses:', error);
                alert('Error saving responses: ' + error.message);
            });
        }

        // Check if all players have completed the quiz
        function checkAllPlayersComplete() {
            if (!currentSession || !database) return;
            
            database.ref('sessions/' + currentSession.code + '/playerResponses').once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) return;
                    
                    const allResponses = snapshot.val();
                    const totalPlayers = currentSession.players.length;
                    const completedPlayers = Object.values(allResponses).filter(r => r.completed).length;
                    
                    console.log(`‚úÖ Completion check: ${completedPlayers}/${totalPlayers} players done`);
                    
                    // Send completion status to game iframe
                    sendCompletionStatusToGame();
                    
                    // If all players are done, notify everyone
                    if (completedPlayers === totalPlayers) {
                        notifyAllPlayersComplete();
                    }
                })
                .catch((error) => {
                    console.error('‚ùå Error checking completion:', error);
                });
        }

        // Send completion status to game iframe
        function sendCompletionStatusToGame() {
            if (!currentSession || !database) return;
            
            database.ref('sessions/' + currentSession.code + '/playerResponses').once('value')
                .then((snapshot) => {
                    const allResponses = snapshot.exists() ? snapshot.val() : {};
                    
                    // Build player status list
                    const playerStatus = currentSession.players.map(player => ({
                        name: player.name,
                        completed: allResponses[player.name]?.completed || false
                    }));
                    
                    // Send to game iframe
                    const gameFrame = document.getElementById('gameFrame');
                    if (gameFrame && gameFrame.contentWindow) {
                        gameFrame.contentWindow.postMessage({
                            action: 'updateCompletionStatus',
                            players: playerStatus
                        }, '*');
                    }
                })
                .catch((error) => {
                    console.error('‚ùå Error sending completion status:', error);
                });
        }

        // Notify all players that everyone is complete
        function notifyAllPlayersComplete() {
            const gameFrame = document.getElementById('gameFrame');
            if (gameFrame && gameFrame.contentWindow) {
                gameFrame.contentWindow.postMessage({
                    action: 'allPlayersComplete'
                }, '*');
            }
        }

        // Hide save button for non-hosts in the game iframe
        function hideSaveButtonForNonHost() {
            const gameFrame = document.getElementById('gameFrame');
            if (gameFrame && gameFrame.contentWindow) {
                gameFrame.contentWindow.postMessage({
                    action: 'hideSaveButton',
                    isHost: currentPlayer.isHost
                }, '*');
            }
        }

        // Download combined responses from all players (host only)
        function downloadCombinedResponses() {
            if (!currentSession || !database) return;
            
            if (!currentPlayer.isHost) {
                alert('Only the host can download combined responses!');
                return;
            }
            
            // Fetch all player responses from Firebase
            database.ref('sessions/' + currentSession.code + '/playerResponses').once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('No responses found yet. Make sure everyone has completed the game.');
                        return;
                    }
                    
                    const allResponses = snapshot.val();
                    generateCombinedSummary(allResponses);
                })
                .catch((error) => {
                    console.error('‚ùå Error fetching responses:', error);
                    alert('Error fetching responses: ' + error.message);
                });
        }

        // Generate combined summary from all players
        function generateCombinedSummary(allResponses) {
            const gameNames = {
                'pacman': 'PAC-RETRO',
                'mario': 'SUPER SPRINT',
                'spaceinvaders': 'SPACE RETRO',
                'tetris': 'TETRO-SPECT'
            };
            
            const gameLevels = {
                'pacman': [
                    { id: 'power_pellets', title: '‚ö° POWER PELLETS', prompt: 'What gave us energy and power this sprint?' },
                    { id: 'ghosts', title: 'üëª GHOSTS TO AVOID', prompt: 'What obstacles or problems should we avoid?' },
                    { id: 'dots', title: '‚Ä¢ DOTS TO COLLECT', prompt: 'What small wins or improvements should we keep collecting?' },
                    { id: 'maze', title: 'üó∫Ô∏è NAVIGATE THE MAZE', prompt: 'What path should we take next?' },
                    { id: 'high_score', title: 'üèÜ HIGH SCORE GOAL', prompt: 'What would make the next sprint a record-breaking success?' },
                    { id: 'iteration_star', title: '‚≠ê ITERATION STAR', prompt: 'Rate this sprint and share your biggest takeaway', type: 'star_rating' }
                ],
                'mario': [
                    { id: 'power_ups', title: 'üçÑ POWER-UPS', prompt: 'What tools, practices, or people powered us up?' },
                    { id: 'obstacles', title: 'üß± OBSTACLES', prompt: 'What blocks or barriers did we hit?' },
                    { id: 'coins', title: 'ü™ô COINS COLLECTED', prompt: 'What valuable things did we gain or learn?' },
                    { id: 'pipes', title: 'üü¢ SECRET PIPES', prompt: 'What shortcuts or better ways of working did we discover?' },
                    { id: 'flag', title: 'üö© NEXT CASTLE', prompt: 'What is our next big goal or milestone?' },
                    { id: 'iteration_star', title: '‚≠ê ITERATION STAR', prompt: 'Rate this sprint and share your biggest takeaway', type: 'star_rating' }
                ],
                'spaceinvaders': [
                    { id: 'invaders', title: 'üëæ INVADERS', prompt: 'What threats or risks are approaching?' },
                    { id: 'shields', title: 'üõ°Ô∏è SHIELDS', prompt: 'What protections or safeguards do we have?' },
                    { id: 'laser', title: 'üî´ LASER SHOTS', prompt: 'What actions should we take to eliminate problems?' },
                    { id: 'ufo', title: 'üõ∏ BONUS UFO', prompt: 'What unexpected opportunities appeared?' },
                    { id: 'next_wave', title: 'üåä NEXT WAVE', prompt: 'What challenges do we expect in the next sprint?' },
                    { id: 'iteration_star', title: '‚≠ê ITERATION STAR', prompt: 'Rate this sprint and share your biggest takeaway', type: 'star_rating' }
                ],
                'tetris': [
                    { id: 'perfect_fit', title: '‚ú® PERFECT FIT', prompt: 'What pieces fit together perfectly?' },
                    { id: 'gaps', title: '‚¨ú GAPS LEFT', prompt: 'What gaps or missing pieces do we still have?' },
                    { id: 'line_clear', title: 'üí• LINE CLEARS', prompt: 'What problems did we completely eliminate?' },
                    { id: 'wrong_piece', title: 'üîÑ WRONG PIECES', prompt: 'What didn\'t fit?' },
                    { id: 'next_piece', title: '‚è≠Ô∏è NEXT PIECE', prompt: 'What do we need next to succeed?' },
                    { id: 'iteration_star', title: '‚≠ê ITERATION STAR', prompt: 'Rate this sprint and share your biggest takeaway', type: 'star_rating' }
                ]
            };
            
            // Get game type from first player's responses
            const firstPlayer = Object.values(allResponses)[0];
            const gameType = firstPlayer.game;
            const gameName = gameNames[gameType] || 'RETROSPECTIVE';
            const levels = gameLevels[gameType] || [];
            
            let content = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n`;
            content += `‚ïë   ${gameName} - TEAM RETROSPECTIVE SUMMARY   ‚ïë\n`;
            content += `‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n`;
            content += `Date: ${new Date().toLocaleDateString()}\n`;
            content += `Session Code: ${currentSession.code}\n`;
            content += `Participants: ${Object.keys(allResponses).length}\n`;
            content += `${'='.repeat(70)}\n\n`;
            
            // For each level, show all players' responses
            levels.forEach((level, index) => {
                content += `\n${'='.repeat(70)}\n`;
                content += `LEVEL ${index + 1}: ${level.title}\n`;
                content += `${'='.repeat(70)}\n`;
                content += `Question: ${level.prompt}\n\n`;
                
                // Show each player's response
                Object.entries(allResponses).forEach(([playerName, playerData]) => {
                    content += `\n--- ${playerName} ---\n`;
                    
                    if (level.type === 'star_rating') {
                        const rating = playerData.responses[level.id + '_rating'] || 0;
                        const comment = playerData.responses[level.id + '_comment'] || 'No comment provided';
                        const stars = '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
                        content += `Rating: ${stars} (${rating}/5)\n`;
                        content += `Takeaway: ${comment}\n`;
                    } else {
                        const response = playerData.responses[level.id] || 'No response provided';
                        content += `${response}\n`;
                    }
                });
                
                content += `\n`;
            });
            
            content += `\n${'='.repeat(70)}\n`;
            content += `\nüéÆ RETROSPECTIVE COMPLETE - THANKS FOR PARTICIPATING! üéÆ\n`;
            
            // Download the file
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `team-retrospective-${gameType}-${currentSession.code}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Mark that responses have been downloaded
            responsesDownloaded = true;
            
            alert('Combined team retrospective downloaded successfully!');
        }
    </script>
</body>
</html>